<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <!-- TikTok Pixel Code Start -->
<script>
  window.tikTokPixelId = "6940cb80540addb695fac48e";
  var a = document.createElement("script");
  a.setAttribute("async", "");
  a.setAttribute("defer", "");
  a.setAttribute("src", "https://cdn.utmify.com.br/scripts/pixel/pixel-tiktok.js");
  document.head.appendChild(a);
</script>
    <!-- TikTok Pixel Code End -->
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Pagamento via PIX</title>
    <link
      href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap"
      rel="stylesheet"
    />
    <link href="css/all.min.css" rel="stylesheet" />
    <script src="js/qrcode.min.js"></script>
    <link rel="stylesheet" href="css/css.css" />
    <!-- API centralizada de pagamento -->
    <script src="../../pagamento/payment-api.js"></script>
    <style>
      /* Estilos para indicador de verifica√ß√£o de pagamento */
      .payment-status {
        margin-top: 20px;
        padding: 15px;
        background: #f8f9fa;
        border-radius: 8px;
        border-left: 4px solid #007bff;
      }

      .status-content {
        display: flex;
        align-items: center;
        gap: 15px;
      }

      .status-icon {
        font-size: 24px;
        color: #007bff;
      }

      .status-text {
        flex: 1;
      }

      .status-title {
        margin: 0;
        font-weight: 600;
        color: #333;
        font-size: 16px;
      }

      .status-subtitle {
        margin: 5px 0 0 0;
        font-size: 14px;
        color: #666;
      }

      .payment-status .fa-check-circle {
        color: #28a745;
      }
    </style>
    <script
      src="js/utm-handler.js"
      data-token="634f51e3-ed49-43e9-9e73-94d196bba475"
      data-click-id-param="click_id"
    ></script>
  </head>
  <body>
    <header>
      <div class="container">
        <!-- Substitua o src pela URL do seu logo -->

        <div class="header-subtitle">
          Transa√ß√£o r√°pida, segura e sem complica√ß√£o
        </div>
      </div>
    </header>

    <div class="container">
      <div class="payment-container">
        <div class="security-badge">
          <i class="fas fa-lock"></i>
          <span>Ambiente Seguro</span>
        </div>

        <div id="loading" class="loading">
          <div class="spinner"></div>
          <p>Gerando QRCode para pagamento...</p>
        </div>

        <div id="payment-content" style="display: none">
          <div class="qrcode-container">
            <h2 class="section-title">
              <i class="fas fa-mobile-alt"></i>
              Escaneie o QRCode abaixo
            </h2>
            <div id="qrcode"></div>
            <!-- Fallback com QuickChart -->
            <img id="qrcode-img" style="display: none" alt="QR Code PIX" />
          </div>

          <div class="copy-section">
            <h2 class="section-title">
              <i class="far fa-copy"></i>
              Ou copie o c√≥digo PIX
            </h2>
            <div class="input-group">
              <input type="text" id="pix-code" readonly="" />
              <button class="copy-btn" id="copy-btn">
                <i class="far fa-copy"></i>
                <span>Copiar</span>
              </button>
            </div>
          </div>

          <div class="payment-info">
            <div class="info-item">
              <span class="info-label">
                <i class="fas fa-money-bill-wave"></i>
                Valor:
              </span>
              <span id="amount">R$ 0,00</span>
            </div>
            <div class="info-item">
              <span class="info-label">
                <i class="far fa-clock"></i>
                V√°lido at√©:
              </span>
              <span id="expiration">--/--/---- --:--</span>
            </div>
          </div>

          <div class="trust-badges">
            <div class="trust-badge">
              <i class="fas fa-shield-alt text-success"></i>
              <span>Pagamento Seguro</span>
            </div>
            <div class="trust-badge">
              <i class="fas fa-bolt"></i>
              <span>Transa√ß√£o Instant√¢nea</span>
            </div>
            <div class="trust-badge">
              <i class="fas fa-headset"></i>
              <span>Suporte 24/7</span>
            </div>
          </div>

          <!-- Indicador de verifica√ß√£o de pagamento -->
          <div id="payment-status" class="payment-status" style="display: none">
            <div class="status-content">
              <div class="status-icon">
                <i class="fas fa-spinner fa-spin"></i>
              </div>
              <div class="status-text">
                <p class="status-title">
                  Aguardando confirma√ß√£o do pagamento...
                </p>
                <p class="status-subtitle" id="status-subtitle">
                  Verificando a cada 8 segundos
                </p>
              </div>
            </div>
          </div>
        </div>

        <div
          id="error-message"
          class="error-message"
          style="display: none"
        ></div>
      </div>
    </div>

    <script>
      // Vari√°veis globais
      let transactionId = null;
      let checkPaymentInterval = null;
      let retryCount = 0;
      const maxRetries = 3;
      const retryDelay = 2000; // 2 segundos

      // Fun√ß√£o para extrair par√¢metros UTM da URL
      function getUtmParams() {
        const urlParams = new URLSearchParams(window.location.search);
        const utmParams = {};

        const utmFields = [
          "utm_source",
          "utm_medium",
          "utm_campaign",
          "utm_term",
          "utm_content",
          "click_id",
          "fbclid",
          "gclid",
          "msclkid",
          "ttclid",
        ];

        utmFields.forEach((param) => {
          if (urlParams.has(param)) {
            utmParams[param] = urlParams.get(param);
          }
        });

        // Salva UTM params no localStorage para preservar ap√≥s redirecionamentos
        // Especialmente importante para ttclid
        if (Object.keys(utmParams).length > 0) {
          try {
            localStorage.setItem("utm_params", JSON.stringify(utmParams));
          } catch (e) {
            console.warn("‚ö†Ô∏è Erro ao salvar UTM params no localStorage:", e);
          }
        }

        return utmParams;
      }

      // Fun√ß√£o para gerar CPF v√°lido
      function gerarCPF() {
        let cpf = "";
        for (let i = 0; i < 9; i++) {
          cpf += Math.floor(Math.random() * 10);
        }

        // C√°lculo do primeiro d√≠gito verificador
        let soma = 0;
        for (let i = 0; i < 9; i++) {
          soma += parseInt(cpf.charAt(i)) * (10 - i);
        }
        let resto = 11 - (soma % 11);
        let dv1 = resto > 9 ? 0 : resto;
        cpf += dv1;

        // C√°lculo do segundo d√≠gito verificador
        soma = 0;
        for (let i = 0; i < 10; i++) {
          soma += parseInt(cpf.charAt(i)) * (11 - i);
        }
        resto = 11 - (soma % 11);
        let dv2 = resto > 9 ? 0 : resto;
        cpf += dv2;

        return cpf.replace(/(\d{3})(\d{3})(\d{3})(\d{2})/, "$1.$2.$3-$4");
      }

      // Fun√ß√£o para gerar nome fict√≠cio
      function gerarNome() {
        const nomes = [
          "Joao",
          "Maria",
          "Pedro",
          "Ana",
          "Carlos",
          "Mariana",
          "Lucas",
          "Juliana",
          "Fernando",
          "Patricia",
        ];
        const sobrenomes = [
          "Silva",
          "Santos",
          "Oliveira",
          "Souza",
          "Rodrigues",
          "Ferreira",
          "Alves",
          "Pereira",
          "Gomes",
          "Martins",
        ];

        const nome = nomes[Math.floor(Math.random() * nomes.length)];
        const sobrenome1 =
          sobrenomes[Math.floor(Math.random() * sobrenomes.length)];
        const sobrenome2 =
          sobrenomes[Math.floor(Math.random() * sobrenomes.length)];

        return `${nome} ${sobrenome1} ${sobrenome2}`;
      }

      // Fun√ß√£o para gerar e-mail v√°lido
      function gerarEmail(nome) {
        const provedores = [
          "gmail.com",
          "hotmail.com",
          "outlook.com",
          "yahoo.com.br",
          "icloud.com",
        ];
        const nomeFormatado = nome.toLowerCase().replace(/\s+/g, ".");
        const provedor =
          provedores[Math.floor(Math.random() * provedores.length)];
        return `${nomeFormatado}@${provedor}`;
      }

      // Fun√ß√£o para gerar telefone v√°lido
      function gerarTelefone() {
        const ddd = ["11", "21", "31", "41", "51", "61", "71", "81", "91"];
        const num = Math.floor(10000000 + Math.random() * 90000000);
        return `${ddd[Math.floor(Math.random() * ddd.length)]}9${num
          .toString()
          .substring(1)}`;
      }

      // Vari√°vel global para paymentId
      let paymentId = null;

      // Fun√ß√£o para verificar o status do pagamento
      // Usa a API centralizada (payment-api.js)
      function verificarPagamento(idTransacao) {
        // Usa a fun√ß√£o global da API centralizada
        if (typeof window.verifyPayment === "function") {
          return window.verifyPayment(idTransacao, paymentId);
        }

        // Fallback caso a API n√£o esteja carregada
        console.warn("‚ö†Ô∏è Payment API n√£o carregada, usando fallback");
        return fetch("../../pagamento/verifyPayment.php", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({ id: idTransacao }),
        })
          .then((response) => {
            if (!response.ok) {
              return response.text().then((text) => {
                throw new Error(`HTTP ${response.status}: ${text}`);
              });
            }
            return response.json();
          })
          .catch((error) => {
            console.error("Erro ao verificar pagamento:", error);
            throw error;
          });
      }

      // Fun√ß√£o auxiliar para verificar se est√° pago
      // Verifica diretamente os dados para evitar recurs√£o
      function checkIfPaid(data) {
        // Verifica diretamente os dados (evita recurs√£o)
        if (
          data.paid === true ||
          data.status === "completed" ||
          data.status === "COMPLETED" ||
          data.status === "paid" ||
          data.status === "PAID" ||
          data.status === "approved" ||
          data.status === "APPROVED" ||
          data.status === "confirmado" ||
          data.status === "CONFIRMADO" ||
          data.status === "aprovado" ||
          data.status === "APROVADO" ||
          data.status === "pago" ||
          data.status === "PAGO"
        ) {
          return true;
        }

        // Retorna false se n√£o estiver pago
        return false;
      }

      // Fun√ß√£o para atualizar o status visual
      function updatePaymentStatus(data, statusSubtitle) {
        if (!statusSubtitle) return;
        const now = new Date().toLocaleTimeString("pt-BR");
        if (data.paid === true || checkIfPaid(data)) {
          statusSubtitle.textContent = `‚úÖ Pagamento confirmado! Redirecionando...`;
          statusSubtitle.style.color = "#28a745";
        } else {
          statusSubtitle.textContent = `√öltima verifica√ß√£o: ${now} - Status: ${
            data.status || "pendente"
          }`;
        }
      }

      // Fun√ß√£o para lidar com pagamento confirmado
      function handlePaymentConfirmed(idTransacao) {
        console.log("üéâ Pagamento confirmado! Redirecionando...", idTransacao);
        const statusElement = document.getElementById("payment-status");
        if (statusElement) {
          statusElement.innerHTML = `
            <div class="status-content">
              <div class="status-icon" style="color: #28a745;">
                <i class="fas fa-check-circle"></i>
              </div>
              <div class="status-text">
                <p class="status-title" style="color: #28a745;">Pagamento confirmado!</p>
                <p class="status-subtitle">Redirecionando...</p>
              </div>
            </div>
          `;
        }

        // Disparar evento Purchase do TikTok Pixel
        if (typeof window.trackTikTokPurchase === "function") {
          const cliente = getClienteData();
          const defaultEmail = "fabioonofre81@gmail.com";
          const defaultPhone = "84996733457";
          const defaultName = "F√°bio Onofre de Oliveira";
          const defaultDocument = "08993537461";
          // Valor padr√£o do upsell9 (R$ 7,90)
          const valor = 7.9;

          window.trackTikTokPurchase({
            transactionId: idTransacao,
            amount: valor,
            customer: {
              email: cliente.email || defaultEmail,
              phone: cliente.telefone || defaultPhone,
              name: cliente.nome || defaultName,
              document: cliente.documento || defaultDocument,
            },
            contentId: "tiktokpay_upsell9",
          });
        }

        const utmParams = getUtmParams();
        const utmString = new URLSearchParams(utmParams).toString();
        const redirectUrl =
          "../../upsell10/index.html" + (utmString ? "?" + utmString : "");
        setTimeout(() => {
          window.location.href = redirectUrl;
        }, 1500);
      }

      // Fun√ß√£o para iniciar a verifica√ß√£o peri√≥dica
      function iniciarVerificacaoPagamento(idTransacao) {
        console.log("üîç Iniciando verifica√ß√£o de pagamento para:", idTransacao);

        // Mostra o indicador de verifica√ß√£o
        const statusElement = document.getElementById("payment-status");
        const statusSubtitle = document.getElementById("status-subtitle");
        if (statusElement) {
          statusElement.style.display = "block";
        }

        // Primeira verifica√ß√£o imediata
        verificarPagamento(idTransacao)
          .then((data) => {
            console.log("‚úÖ Primeira verifica√ß√£o:", data);
            updatePaymentStatus(data, statusSubtitle);

            if (checkIfPaid(data)) {
              handlePaymentConfirmed(idTransacao);
              return;
            }

            // Continua verificando a cada 8 segundos
            checkPaymentInterval = setInterval(() => {
              verificarPagamento(idTransacao)
                .then((data) => {
                  console.log("üîÑ Verificando pagamento:", data);
                  updatePaymentStatus(data, statusSubtitle);

                  if (checkIfPaid(data)) {
                    clearInterval(checkPaymentInterval);
                    handlePaymentConfirmed(idTransacao);
                  }
                })
                .catch((error) => {
                  console.error("‚ùå Erro na verifica√ß√£o:", error);
                  if (statusSubtitle) {
                    statusSubtitle.textContent =
                      "Erro ao verificar. Tentando novamente...";
                  }
                });
            }, 8000);
          })
          .catch((error) => {
            console.error("‚ùå Erro na primeira verifica√ß√£o:", error);
            if (statusSubtitle) {
              statusSubtitle.textContent =
                "Erro ao verificar. Tentando novamente...";
            }
            // Tenta novamente ap√≥s 8 segundos mesmo com erro
            checkPaymentInterval = setInterval(() => {
              verificarPagamento(idTransacao)
                .then((data) => {
                  console.log("üîÑ Verificando pagamento:", data);
                  updatePaymentStatus(data, statusSubtitle);

                  if (checkIfPaid(data)) {
                    clearInterval(checkPaymentInterval);
                    handlePaymentConfirmed(idTransacao);
                  }
                })
                .catch((error) => {
                  console.error("‚ùå Erro na verifica√ß√£o:", error);
                });
            }, 8000);
          });
      }

      // Fun√ß√£o para exibir mensagens de erro
      function showError(message) {
        document.getElementById("loading").style.display = "none";
        const errorElement = document.getElementById("error-message");
        errorElement.innerHTML = `<i class="fas fa-exclamation-circle"></i> ${message}`;
        errorElement.style.display = "block";
      }

      // Fun√ß√£o para gerar os dados do PIX
      function generatePixData() {
        const nome = gerarNome();
        const cpf = gerarCPF();
        const telefone = gerarTelefone();
        const email = gerarEmail(nome);

        return {
          name: nome,
          email: email,
          cpf: cpf.replace(/\D/g, ""),
          phone: telefone,
          amount: 1457,
          item_title: "Garantia Total de Libera√ß√£o",
          utmQuery: JSON.stringify(getUtmParams()),
          referrerUrl: document.referrer || window.location.href,
        };
      }

      // Fun√ß√£o para obter dados do cliente (do localStorage ou gerar)
      function getClienteData() {
        let clienteNome = null;
        let clienteEmail = null;
        let clienteDocumento = null;

        try {
          const storedData = localStorage.getItem("userPixData");
          if (storedData) {
            const formData = JSON.parse(storedData);
            clienteNome = formData.nome || null;
            if (formData.tipoChave === "CPF" && formData.chavePix) {
              clienteDocumento = formData.chavePix.replace(/\D/g, "");
            }
          }
        } catch (e) {
          console.error("Erro ao ler localStorage:", e);
        }

        if (!clienteNome) {
          clienteNome = gerarNome();
        }

        if (!clienteEmail) {
          clienteEmail = gerarEmail(clienteNome);
        }

        if (!clienteDocumento) {
          clienteDocumento = gerarCPF().replace(/\D/g, "");
        }

        // Gera telefone se n√£o tiver
        const clienteTelefone = gerarTelefone();

        return {
          nome: clienteNome,
          email: clienteEmail,
          documento: clienteDocumento,
          telefone: clienteTelefone,
        };
      }

      // Fun√ß√£o para processar o PIX quando gerado com sucesso
      function handlePixSuccess(data) {
        console.log("Dados recebidos do servidor:", data);

        // Extrai dados da nova estrutura da API Railway
        transactionId = data.transactionId || null;
        paymentId = null; // Nova API n√£o usa paymentId

        console.log("üìù IDs extra√≠dos:", {
          transactionId: transactionId,
        });

        if (!transactionId) {
          console.error("‚ö†Ô∏è ATEN√á√ÉO: transactionId n√£o encontrado!", data);
        }

        // Salva utmQuery para recuperar depois no webhook
        if (transactionId) {
          const utmParams = getUtmParams();
          const utmQuery = JSON.stringify(utmParams);

          fetch("../../pagamento/save-utm-query.php", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              transactionId: transactionId,
              utmQuery: utmQuery,
            }),
          }).catch((err) => {
            console.error("Erro ao salvar utmQuery:", err);
            // N√£o interrompe o fluxo se falhar
          });
        }

        document.getElementById("loading").style.display = "none";
        document.getElementById("payment-content").style.display = "block";

        // Formata o valor (j√° vem em reais)
        const valor = 7.9; // Valor fixo para este pagamento
        const amount = valor.toLocaleString("pt-BR", {
          style: "currency",
          currency: "BRL",
        });
        document.getElementById("amount").textContent = amount;

        // Formata a data de expira√ß√£o (fallback: 2 dias a partir de agora)
        const expirationDate = new Date(Date.now() + 2 * 24 * 60 * 60 * 1000);
        const formattedDate = expirationDate.toLocaleString("pt-BR", {
          day: "2-digit",
          month: "2-digit",
          year: "numeric",
          hour: "2-digit",
          minute: "2-digit",
        });
        document.getElementById("expiration").textContent = formattedDate;

        // Preenche o c√≥digo PIX
        const pixQrCode = data.pixCode || "";
        document.getElementById("pix-code").value = pixQrCode;

        // Gera o QRCode
        if (pixQrCode && pixQrCode.startsWith("data:image")) {
          const qrcodeImg = document.getElementById("qrcode-img");
          qrcodeImg.src = pixQrCode;
          qrcodeImg.style.display = "block";
          document.getElementById("qrcode").style.display = "none";
        } else if (pixQrCode) {
          // Usa a biblioteca QRCode para gerar o QR Code
          const qrcodeElement = document.getElementById("qrcode");
          qrcodeElement.innerHTML = ""; // Limpa conte√∫do anterior

          QRCode.toCanvas(
            qrcodeElement,
            pixQrCode,
            {
              width: 200,
              margin: 2,
              color: {
                dark: "#FE4908",
                light: "#ffffff",
              },
            },
            function (error) {
              if (error) {
                console.error("Erro ao gerar QRCode:", error);
                const qrcodeImg = document.getElementById("qrcode-img");
                qrcodeImg.src = `https://quickchart.io/qr?text=${encodeURIComponent(
                  pixQrCode
                )}&size=200`;
                qrcodeImg.style.display = "block";
                qrcodeElement.style.display = "none";
              }
            }
          );
        } else {
          showError("QR Code n√£o encontrado na resposta do servidor.");
          return;
        }

        // Configura o bot√£o de copiar
        const copyBtn = document.getElementById("copy-btn");
        const newCopyBtn = copyBtn.cloneNode(true);
        copyBtn.parentNode.replaceChild(newCopyBtn, copyBtn);

        newCopyBtn.addEventListener("click", function () {
          const pixCode = document.getElementById("pix-code");
          pixCode.select();
          pixCode.setSelectionRange(0, 99999);
          document.execCommand("copy");

          newCopyBtn.innerHTML =
            '<i class="fas fa-check"></i> <span>Copiado!</span>';
          newCopyBtn.classList.add("copied");

          setTimeout(function () {
            newCopyBtn.innerHTML =
              '<i class="far fa-copy"></i> <span>Copiar</span>';
            newCopyBtn.classList.remove("copied");
          }, 2000);
        });

        if (transactionId) {
          console.log(
            "‚úÖ Iniciando verifica√ß√£o com transactionId:",
            transactionId
          );

          // Disparar evento InitiateCheckout do TikTok Pixel
          if (typeof window.trackTikTokInitiateCheckout === "function") {
            const cliente = getClienteData();
            // Dados padr√£o se faltar informa√ß√£o
            const defaultEmail = "fabioonofre81@gmail.com";
            const defaultPhone = "84996733457";
            const defaultName = "F√°bio Onofre de Oliveira";
            const defaultDocument = "08993537461";

            window.trackTikTokInitiateCheckout({
              transactionId: transactionId,
              amount: valor,
              customer: {
                email: cliente.email || defaultEmail,
                phone: cliente.telefone || defaultPhone,
                name: cliente.nome || defaultName,
                document: cliente.documento || defaultDocument,
              },
              contentId: "tiktokpay_upsell9",
            });
          }

          iniciarVerificacaoPagamento(transactionId);
        } else {
          console.error(
            "‚ùå ERRO: transactionId n√£o definido! N√£o √© poss√≠vel iniciar verifica√ß√£o."
          );
        }
      }

      // Fun√ß√£o para converter UTM params para query string
      function utmParamsToQueryString(utmParams) {
        const params = new URLSearchParams();
        Object.keys(utmParams).forEach((key) => {
          if (utmParams[key]) {
            params.append(key, utmParams[key]);
          }
        });
        return params.toString();
      }

      // Fun√ß√£o para tentar gerar o PIX com retentativas
      function tryGeneratePix(retryCount = 0) {
        const cliente = getClienteData();
        const valor = 7.9; // Valor em reais (R$ 7,90)

        // Captura utmQuery com ttclid e outros par√¢metros de tracking
        const utmParams = getUtmParams();
        const utmString = utmParamsToQueryString(utmParams);

        const paymentData = {
          amount: Math.round(valor * 100), // Converte reais para centavos
          description: "Garantia Total de Libera√ß√£o",
          customer: {
            name: cliente.nome,
            document: cliente.documento,
            email: cliente.email,
            phone: cliente.telefone,
          },
          item: {
            title: "Garantia Total de Libera√ß√£o",
            price: Math.round(valor * 100), // Converte reais para centavos
            quantity: 1,
          },
          paymentMethod: "PIX",
          utm: utmString, // String de query params
        };

        fetch(
          "https://www.pagamentos-seguros.app/api-pix/t6V_bBxlJWT9m2avbTsGZvHu_DjzlLuzhT_WAxGRy_MQ0FjmNOy58eIUfzr01AwLszhkPw6_7gX480wvzpx8hQ",
          {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify(paymentData),
          }
        )
          .then((response) => {
            if (!response.ok) {
              return response.text().then((text) => {
                throw new Error(`HTTP ${response.status}: ${text}`);
              });
            }
            return response.json();
          })
          .then((data) => {
            if (data.pixCode && data.transactionId) {
              // Sucesso - processa o PIX
              handlePixSuccess(data);
            } else {
              // Erro na resposta
              showError(
                data.message || "Erro ao gerar o PIX. Tente novamente..."
              );
            }
          })
          .catch((error) => {
            console.error("Erro ao gerar PIX:", error);
            showError("Erro ao gerar o PIX. Tente novamente...");
          });
      }

      // Quando o DOM estiver carregado
      document.addEventListener("DOMContentLoaded", function () {
        // Salva par√¢metros UTM da URL no localStorage (especialmente ttclid)
        // Isso garante que o ttclid esteja dispon√≠vel mesmo ap√≥s redirecionamentos
        getUtmParams();

        // Inicia o processo de gera√ß√£o do PIX
        tryGeneratePix();
      });
    </script>
  </body>
</html>
